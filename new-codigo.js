var micanvas=document.getElementById("caja"),lienzo=micanvas.getContext("2d"),micanvas2=document.getElementById("canvitas"),canvitas=micanvas2.getContext("2d"),game=document.getElementById("tetris"),dato2=document.getElementById("speed"),dato3=document.getElementById("n_piezas"),dato4=document.getElementById("puntos"),over=document.getElementById("over"),start=document.getElementById("start"),boton_over=document.getElementById("boton_over"),sonido1=document.getElementById("efecto1"),sonido2=document.getElementById("efecto2"),sonido3=document.getElementById("efecto3"),sonido4=document.getElementById("efecto4"),musica=document.getElementById("musica"),plano2=document.getElementById("segundo_plano"),boton_over=document.getElementById("boton_over"),boton_start=document.getElementById("boton_start"),b_arriba=document.getElementById("b_arriba"),b_abajo=document.getElementById("b_abajo"),b_izquierda=document.getElementById("b_izquierda"),b_derecha=document.getElementById("b_derecha"),score_data=document.getElementById("score_data"),score_user=document.getElementById("score_user"),t_user=document.getElementById("t_user"),input_nombre=document.getElementById("input_name"),input_telefono=document.getElementById("input_number"),puntuacion_resumen=document.getElementById("puntuacion_resumen"),max_user_con=document.getElementById("usuarios_activos"),mapa=[{x:1,y:50}],figura=[{x:0,y:2,color:1},{x:1,y:1,color:1},{x:1,y:2,color:1},{x:2,y:1,color:1}],pieza_actual=10,pieza_siquiente=10,pieza_posicion=0,altura=-2,speed_game=1,desplazamiento=1,speed=speed_game,tiempo=1,puntuación=(lienzo.fillStyle="#000099",lienzo.strokeStyle="#990000",0),no_piezas=0,contador_nivel=0,record=null,usuario_nombre=null,usuario_telef=null,id_user=NaN,figura_siguiente=elegir(!0,1,pieza_posicion);function mostrar(){lienzo.clearRect(0,0,200,400),canvitas.clearRect(0,0,40,40),mapa.forEach(e=>{lienzo.strokeStyle="black",lienzo.fillStyle=getColor(e.color),lienzo.fillRect(20*e.x,20*e.y,20,20),lienzo.lineTo(20*e.x+20,20*e.y),lienzo.lineTo(20*e.x+20,20*e.y+20),lienzo.strokeRect(20*e.x+1,20*e.y+1,18,18)}),figura_siguiente.forEach(e=>{canvitas.lineWidth=.2,canvitas.strokeStyle="black",canvitas.fillStyle=getColor(e.color),canvitas.fillRect(10*e.x,10*e.y,10,10),canvitas.strokeRect(10*e.x+1,10*e.y+1,8,8)}),figura.forEach(e=>{lienzo.strokeStyle="black",lienzo.fillStyle=getColor(e.color),lienzo.fillRect(20*(e.x+desplazamiento),20*(e.y+altura),20,20),lienzo.strokeRect(20*(e.x+desplazamiento)+1,20*(e.y+altura)+1,18,18)}),60/speed<++tiempo&&(tiempo=1,mover(),++altura)}function agregar(){parseInt(10*Math.random()),parseInt(20*Math.random());mostrar()}function mover(){iscoll(figura,mapa,"rotar")?(puntuacion_resumen.innerHTML=puntuación,conneccion_1(),musica.pause(),clearInterval(frame),clearInterval(ajax_time),over.style.display="block",plano2.style.display="none",id_user=NaN):isfloor(figura,mapa)?(transferir(),sonido2.load(),sonido2.play(),chequear(),nueva_pieza()):19<altura&&nueva_pieza()}function elegir(e,o=10,a=0){o=1==e?10*(parseInt(7*Math.random())+1):o;switch(1==e&&(pieza_siquiente=o,a=pieza_posicion=0),o+a){case 10:return[{x:0,y:2,color:1},{x:1,y:1,color:1},{x:1,y:2,color:1},{x:2,y:1,color:1}];case 11:return[{x:1,y:1,color:1},{x:1,y:2,color:1},{x:2,y:2,color:1},{x:2,y:3,color:1}];case 12:return[{x:0,y:2,color:1},{x:1,y:1,color:1},{x:1,y:2,color:1},{x:2,y:1,color:1}];case 13:return[{x:1,y:1,color:1},{x:1,y:2,color:1},{x:2,y:2,color:1},{x:2,y:3,color:1}];case 20:return[{x:0,y:2,color:2},{x:1,y:2,color:2},{x:2,y:2,color:2},{x:3,y:2,color:2}];case 21:return[{x:1,y:0,color:2},{x:1,y:1,color:2},{x:1,y:2,color:2},{x:1,y:3,color:2}];case 22:return[{x:0,y:2,color:2},{x:1,y:2,color:2},{x:2,y:2,color:2},{x:3,y:2,color:2}];case 23:return[{x:1,y:0,color:2},{x:1,y:1,color:2},{x:1,y:2,color:2},{x:1,y:3,color:2}];case 30:return[{x:0,y:1,color:3},{x:1,y:1,color:3},{x:1,y:2,color:3},{x:2,y:2,color:3}];case 31:return[{x:1,y:2,color:3},{x:1,y:3,color:3},{x:2,y:1,color:3},{x:2,y:2,color:3}];case 32:return[{x:0,y:1,color:3},{x:1,y:1,color:3},{x:1,y:2,color:3},{x:2,y:2,color:3}];case 33:return[{x:1,y:2,color:3},{x:1,y:3,color:3},{x:2,y:1,color:3},{x:2,y:2,color:3}];case 40:return[{x:0,y:2,color:4},{x:1,y:1,color:4},{x:1,y:2,color:4},{x:2,y:2,color:4}];case 41:return[{x:1,y:3,color:4},{x:1,y:1,color:4},{x:1,y:2,color:4},{x:2,y:2,color:4}];case 42:return[{x:0,y:2,color:4},{x:1,y:3,color:4},{x:1,y:2,color:4},{x:2,y:2,color:4}];case 43:return[{x:1,y:3,color:4},{x:1,y:1,color:4},{x:1,y:2,color:4},{x:0,y:2,color:4}];case 50:case 51:case 52:case 53:return[{x:1,y:1,color:5},{x:1,y:2,color:5},{x:2,y:1,color:5},{x:2,y:2,color:5}];case 60:return[{x:1,y:1,color:6},{x:1,y:2,color:6},{x:2,y:2,color:6},{x:3,y:2,color:6}];case 61:return[{x:1,y:1,color:6},{x:1,y:2,color:6},{x:1,y:3,color:6},{x:2,y:1,color:6}];case 62:return[{x:0,y:1,color:6},{x:1,y:1,color:6},{x:2,y:1,color:6},{x:2,y:2,color:6}];case 63:return[{x:2,y:0,color:6},{x:2,y:1,color:6},{x:2,y:2,color:6},{x:1,y:2,color:6}];case 70:return[{x:0,y:2,color:7},{x:1,y:2,color:7},{x:2,y:2,color:7},{x:2,y:1,color:7}];case 71:return[{x:1,y:0,color:7},{x:1,y:1,color:7},{x:1,y:2,color:7},{x:2,y:2,color:7}];case 72:return[{x:1,y:1,color:7},{x:1,y:2,color:7},{x:2,y:1,color:7},{x:3,y:1,color:7}];case 73:return[{x:1,y:1,color:7},{x:2,y:1,color:7},{x:2,y:2,color:7},{x:2,y:3,color:7}]}}function getColor(e){switch(e){case 1:return"rgb(255,0,0)";case 2:return"rgb(0,255,0)";case 3:return"rgb(251, 255, 39)";case 4:return"rgb(0,255,255)";case 5:return"rgb(255,0,255)";case 6:return"rgb(255, 102, 0)";case 7:return"rgb(30, 45, 255)";case 8:return"rgb(200,200,200)"}}function isfloor(e,a){return null!=e&&null!=a&&!!e.some(o=>a.some(e=>o.y+altura==e.y-1&&o.x+desplazamiento==e.x||o.y+altura==19))}function transferir(){figura.forEach(e=>{e.color=8});var e=figura.map(e=>({x:e.x+desplazamiento,y:e.y+altura,color:8}));mapa.push(...e)}function nueva_pieza(){(figura=[]).push(...figura_siguiente),pieza_actual=pieza_siquiente,figura_siguiente=elegir(!0,1,pieza_posicion),desplazamiento=parseInt(6*Math.random()),altura=-4,speed=speed_game,++no_piezas,++contador_nivel,actualizar_pizarra()}function iscoll(e,a,r){return!!e.some(o=>a.some(e=>{switch(r){case"izquierda":return o.x+desplazamiento<=0||o.x+desplazamiento==e.x+1&&o.y+altura==e.y;case"derecha":return 9<=o.x+desplazamiento||o.x+desplazamiento==e.x-1&&o.y+altura==e.y;case"rotar":return o.y+altura==e.y&&o.x+desplazamiento==e.x||o.x+desplazamiento<0||9<o.x+desplazamiento||19<o.y+altura}}))}function borrar_fila(e,o){mapa=e.filter(e=>e.y!=o)}function chequear(){let a=0,r=0;for(let o=0;o<20;o++)mapa.forEach(e=>{e.y==o&&10==++a&&(borrar_fila(mapa,o),reagrupar(o),++r)}),a=0;puntuación+=10*r*speed_game}function reagrupar(o){sonido3.load(),sonido3.play(),mapa.forEach(e=>{e.y<o&&(e.y=e.y+1)}),100<=contador_nivel&&speed_game<11&&(++speed_game,contador_nivel=0)}function actualizar_pizarra(){dato3.innerHTML=no_piezas,dato2.innerHTML=speed,dato4.innerHTML=puntuación}window.addEventListener("keydown",o=>{switch(o.key){case"ArrowLeft":iscoll(figura,mapa,"izquierda")||(sonido4.pause(),sonido4.play(),--desplazamiento);break;case"ArrowRight":iscoll(figura,mapa,"derecha")||(sonido4.pause(),sonido4.play(),++desplazamiento);break;case"ArrowUp":let e=pieza_posicion;3<++e&&(e=0),iscoll(elegir(!1,pieza_actual,e),mapa,"rotar")||(3<++pieza_posicion&&(pieza_posicion=0),sonido1.load(),sonido1.play(),figura=elegir(!1,pieza_actual,pieza_posicion));break;case"ArrowDown":speed=30}}),window.addEventListener("keyup",e=>{"ArrowDown"==e.key&&(speed=speed_game)}),boton_over.onclick=function(){over.style.display="none",plano2.style.display="block",mapa=[{x:1,y:50}],nueva_pieza(),speed=speed_game=1,contador_nivel=no_piezas=puntuación=0,actualizar_pizarra(),frame=setInterval(mostrar,16),ajax_time=setInterval(conneccion_2,1e3),musica.load(),musica.volume=.2,musica.play()},boton_start.onclick=function(){console.log(input_nombre.value),console.log(input_telefono.value),""==input_nombre.value||""==input_telefono.value||input_telefono.value<5e7||59999999<input_telefono.value?alert("Tu informacion está incompleta,o no es válida"):(sonido1.play(),sonido1.pause(),sonido2.play(),sonido2.pause(),sonido3.play(),sonido3.pause(),sonido4.play(),sonido4.pause(),musica.load(),musica.volume=.2,musica.play(),start.style.display="none",plano2.style.display="block",mapa=[{x:1,y:50}],nueva_pieza(),speed=speed_game=1,contador_nivel=no_piezas=puntuación=0,usuario_nombre=input_nombre.value,usuario_telef=input_telefono.value,t_user.innerHTML=usuario_telef,actualizar_pizarra(),frame=setInterval(mostrar,16),ajax_time=setInterval(conneccion_2,1e3))},b_abajo.ontouchstart=function(){speed=30},b_abajo.ontouchend=function(){speed=speed_game},b_arriba.onclick=function(){let e=pieza_posicion;3<++e&&(e=0),iscoll(elegir(!1,pieza_actual,e),mapa,"rotar")||(3<++pieza_posicion&&(pieza_posicion=0),sonido1.load(),sonido1.play(),figura=elegir(!1,pieza_actual,pieza_posicion))},b_izquierda.onclick=function(){iscoll(figura,mapa,"izquierda")||(--desplazamiento,sonido4.pause(),sonido4.play())},b_derecha.onclick=function(){iscoll(figura,mapa,"derecha")||(++desplazamiento,sonido4.pause(),sonido4.play())};